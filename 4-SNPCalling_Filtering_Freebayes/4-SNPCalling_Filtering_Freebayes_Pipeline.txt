#################################
STEP 4. SNP CALLING AND FILTERING
#################################


#--------------------------------------- Call SNPs with Freebayes
#More info on the freebayes program can be found on the associated GitHub page: https://github.com/ekg/freebayes

<code>
nano freebayes_hea.sh 

#!/bin/bash -l

#SBATCH -o freebayes_hea.txt
#SBATCH -n 1
#SBATCH --mail-user=haich001@odu.edu
#SBATCH --mail-type=END
#SBATCH --job-name=freebayes_hea

module load dDocent/2.24
freebayes --genotype-qualities -f /cm/shared/courses/dbarshis/barshislab/Hannah/2018-Feb_Berkeley/sandbox/Barshis/ReferenceAssemblies/HEA_AstrangiaAssembly_Trinity.fasta *.bam > mergedfastq_HEAAstrangiaAssembly.vcf
</code>

#To determine number of SNPs in the original, un-filtered vcf file:
<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf mergedfastq_HEAAstrangiaAssembly.vcf
</code>

<output>
VCFtools - v0.1.12b
(C) Adam Auton and Anthony Marcketta 2009

Parameters as interpreted:
	--vcf mergedfastq_HEAAstrangiaAssembly.vcf

After filtering, kept 40 out of 40 Individuals
After filtering, kept 1214003 out of a possible 1214003 Sites
Run Time = 15.00 seconds
</output>

#--------------------------------------- Subset SNPs by those occurring on host contigs using vcfsubsetter_advbioinf.py script. Separate files for host and symbiont will be used for downstream analyses.

<code>
/cm/shared/courses/dbarshis/18AdvBioinf/scripts/vcfsubsetter_advbioinf.py GoodCoralGenelistForVCFSubsetter.txt mergedfastq_HEAAstrangiaAssembly.vcf 
</code>

#Now look again at number of SNPs
<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf mergedfastq_HEAAstrangiaAssembly_coralsubset.vcf 
</code>
<output>
VCFtools - v0.1.12b
(C) Adam Auton and Anthony Marcketta 2009

Parameters as interpreted:
	--vcf mergedfastq_HEAAstrangiaAssembly_subset.vcf

After filtering, kept 40 out of 40 Individuals
After filtering, kept 432676 out of a possible 432676 Sites
Run Time = 4.00 seconds
</output>

#--------------------------------------- Subset SNPs by those occurring on symbiont contigs using vcfsubsetter_advbioinf.py script. 

<code>
/cm/shared/courses/dbarshis/18AdvBioinf/scripts/vcfsubsetter_advbioinf.py GoodSymGenelistForVCFSubsetter.txt mergedfastq_HEAAstrangiaAssembly.vcf
</code>

#Look at number of SNPs
<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf mergedfastq_HEAAstrangiaAssembly_symsubset.vcf
</code>
<output>
VCFtools - v0.1.12b
(C) Adam Auton and Anthony Marcketta 2009

Parameters as interpreted:
	--vcf mergedfastq_HEAAstrangiaAssembly_symsubset.vcf

After filtering, kept 40 out of 40 Individuals
After filtering, kept 16417 out of a possible 16417 Sites
Run Time = 2.00 seconds
</output?

#--------------------------------------- Robustly filter VCF file to include only high quality SNPs

###First, for HOST SNPs
<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf mergedfastq_HEAAstrangiaAssembly_subset.vcf --max-missing 0.5 --mac 3 --minQ 30 --minDP 10 --max-alleles 2 --maf 0.015 --remove-indels --recode --recode-INFO-all --out subset_1578
</code>
<output>
VCFtools - v0.1.12b
(C) Adam Auton and Anthony Marcketta 2009

Parameters as interpreted:
	--vcf mergedfastq_HEAAstrangiaAssembly_subset.vcf
	--recode-INFO-all
	--mac 3
	--maf 0.015
	--max-alleles 2
	--minDP 10
	--minQ 30
	--max-missing 0.5
	--out subset_1578
	--recode
	--remove-indels

After filtering, kept 40 out of 40 Individuals
Outputting VCF file...
After filtering, kept 1578 out of a possible 432676 Sites
Run Time = 9.00 seconds
</output>

#Use program dDocent to further filter vcf file 
<code>
module load dDocent/2.24
</code>

#First, convert variant calls to SNPs
<code>
vcfallelicprimitives subset_1578.recode.vcf --keep-info --keep-geno > subset_1578.prim.vcf
</code>

#Apply a Hardy-Weinberg Equilibrium filter coding the data as two populations (Virginia and Rhode Island; 2-Population Host)
<code>
./filter_hwe_by_pop.pl -v subset_1578.prim.vcf -p merged_popfile.txt -o subset_1513_2POP.HWE -h 0.01
</code>
<output>
Processing population: RI (20 inds)
Processing population: VA (20 inds)
Outputting results of HWE test for filtered loci to 'filtered.hwe'
Kept 1513 of a possible 1578 loci (filtered 65 loci)
</code>

#Apply a Hardy-Weinberg Equilibrium filter coding the data as four populations (Virginia-Brown, Virginia-White, Rhode Island-Brown, and Rhode Island-White; 4-Population Host)
<code>
./filter_hwe_by_pop.pl -v subset_1578.prim.vcf -p merged_popfile_4pop.txt -o subset_1569_4POP.HWE -h 0.01
</code>
<output>
Processing population: RI_B (10 inds)
Processing population: RI_W (10 inds)
Processing population: VA_B (10 inds)
Processing population: VA_W (10 inds)
Outputting results of HWE test for filtered loci to 'filtered.hwe'
Kept 1569 of a possible 1578 loci (filtered 9 loci)
</output>

###Now, for SYMBIONT SNPs
#First, remove aposymbiotic individuals from symbiont vcf file to avoid missing data. Did this because there were very few symbiont reads from aposymbiotic corals.

<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf mergedfastq_HEAAstrangiaAssembly_symsubset.vcf --remove apo_individs_2pop.txt --recode --recode-INFO-all --out symsubset_brownindivids
</code>
<output>
VCFtools - v0.1.12b
(C) Adam Auton and Anthony Marcketta 2009

Parameters as interpreted:
	--vcf mergedfastq_HEAAstrangiaAssembly_symsubset.vcf
	--exclude apo_individs_2pop.txt
	--recode-INFO-all
	--out symsubset_brownindivids
	--recode

Excluding individuals in 'exclude' list
After filtering, kept 20 out of 40 Individuals
Outputting VCF file...
After filtering, kept 16417 out of a possible 16417 Sites
Run Time = 5.00 seconds
</output>

<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf symsubset_brownindivids.recode.vcf --max-missing 0.5 --mac 3 --minQ 30 --minDP 10 --max-alleles 2 --maf 0.015 --remove-indels --recode --recode-INFO-all --out symsubset_brownindivids_79
</code>
<output>
VCFtools - v0.1.12b
(C) Adam Auton and Anthony Marcketta 2009

Parameters as interpreted:
	--vcf symsubset_brownindivids.recode.vcf
	--recode-INFO-all
	--mac 3
	--maf 0.015
	--max-alleles 2
	--minDP 10
	--minQ 30
	--max-missing 0.5
	--out symsubset_brownindivids_79
	--recode
	--remove-indels

After filtering, kept 20 out of 20 Individuals
Outputting VCF file...
After filtering, kept 79 out of a possible 16417 Sites
Run Time = 1.00 seconds
</code>

#Convert variant calls to SNPs
<code>
vcfallelicprimitives symsubset_brownindivids_79.recode.vcf --keep-info --keep-geno > symsubset_brownindivids_79.prim.vcf
</code>

#Apply a Hardy-Weinberg Equilibrium filter coding the data as two populations (Virginia-Brown and Rhode Island-Brown)

<code>
./filter_hwe_by_pop.pl -v symsubset_brownindivids_79.prim.vcf -p merged_popfile_2pop_brown.txt -o symsubset_brownindivids_79.HWE -h 0.01
</code>

#--------------------------------------- Remove SNPs from contigs that are labeled as both coral and symbiont in the reference transcriptome using the --not-chr flag from vcftools

###4-POPULATION HOST
<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf subset_1569_4POP.HWE.recode.vcf --not-chr 'TR26801|c0_g2_i1' --not-chr 'TR31122|c0_g1_i1' --not-chr 'TR32974|c0_g1_i1' --not-chr 'TR41328|c0_g1_i1' --not-chr 'TR50118|c0_g1_i1' --not-chr 'TR50355|c0_g1_i1' --not-chr 'TR60158|c0_g1_i1' --not-chr 'TR6472|c0_g1_i1' --recode --recode-INFO-all --out finalcoralsubset_1562_4POP
</code>

#2-POPULATION HOST
<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf subset_1513_2POP.HWE.recode.vcf --not-chr 'TR26801|c0_g2_i1' --not-chr 'TR31122|c0_g1_i1' --not-chr 'TR32974|c0_g1_i1' --not-chr 'TR41328|c0_g1_i1' --not-chr 'TR50118|c0_g1_i1' --not-chr 'TR50355|c0_g1_i1' --not-chr 'TR60158|c0_g1_i1' --not-chr 'TR6472|c0_g1_i1' --recode --recode-INFO-all --out finalcoralsubset_1506_2POP
</code>

#SYMBIONT
<code>
/cm/shared/apps/vcftools/0.1.12b/bin/vcftools --vcf symsubset_brownindivids_79.HWE.recode.vcf --not-chr 'TR13309|c0_g1_i1' --not-chr 'TR13309|c0_g1_i2' --not-chr 'TR13309|c0_g1_i3' --not-chr 'TR13309|c0_g1_i4' --not-chr 'TR19140|c0_g2_i1' --not-chr 'TR19353|c0_g1_i1' --not-chr 'TR19427|c0_g1_i1' --not-chr 'TR19427|c0_g1_i3' --not-chr 'TR24711|c1_g1_i1' --not-chr 'TR24787|c0_g5_i1' --not-chr 'TR25041|c0_g1_i1' --not-chr 'TR25041|c0_g1_i3' --not-chr 'TR26801|c0_g2_i1' --not-chr 'TR28653|c0_g2_i1' --not-chr 'TR28653|c0_g2_i2' --not-chr 'TR29974|c0_g1_i12' --not-chr 'TR29974|c0_g1_i1' --not-chr 'TR29974|c0_g1_i3' --not-chr 'TR29974|c0_g1_i8' --not-chr 'TR3445|c0_g1_i2' --not-chr 'TR35211|c2_g1_i1' --not-chr 'TR42333|c0_g1_i1' --not-chr 'TR45252|c0_g1_i1' --not-chr 'TR46343|c0_g1_i1' --not-chr 'TR47096|c0_g1_i1' --not-chr 'TR47121|c0_g2_i1' --not-chr 'TR47308|c0_g1_i1' --not-chr 'TR47946|c1_g1_i5' --not-chr 'TR47983|c0_g4_i1' --not-chr 'TR50118|c0_g1_i1' --not-chr 'TR50217|c0_g2_i1' --not-chr 'TR53939|c0_g1_i1' --not-chr 'TR56194|c0_g2_i1' --not-chr 'TR58010|c0_g2_i3' --not-chr 'TR59703|c0_g1_i1' --not-chr 'TR59703|c0_g1_i3' --not-chr 'TR59704|c0_g3_i1' --not-chr 'TR60640|c0_g3_i1' --recode --recode-INFO-all --out finalsymsubset_68
</code>

#--------------------------------------- Convert vcf files to genepop format
#Genepop file format will be used in the program Genodive

/cm/shared/courses/dbarshis/18AdvBioinf/scripts/vcftogenepop_advbioinf.py finalcoralsubset_1562_4POP.recode.vcf merged_popfile_4pop.txt 

/cm/shared/courses/dbarshis/18AdvBioinf/scripts/vcftogenepop_advbioinf.py finalcoralsubset_1506_2POP.recode.vcf merged_popfile.txt 

/cm/shared/courses/dbarshis/18AdvBioinf/scripts/vcftogenepop_advbioinf.py finalsymsubset_68.recode.vcf merged_popfile_2pop_brown.txt 

#--------------------------------------- Filter the vcf files to include only one SNP per contig using the Filter_one_random_snp_per_contig.sh script.

#The full SNP datasets produced here (4-Population Host, 2-Population Host, and Symbiont) are only used for outlier scanning (conducted using the program Baypass, see section 5)
#All other analyses are completed on files that are reduced to 1 SNP/contig. This is to address issues with linkage of SNPs.

#The Filter_one_random_snp_per_contig.sh script is part of the dDocent module
<code>
module load dDocent/2.24

bash Filter_one_random_snp_per_contig.sh finalcoralsubset_1506_2POP.recode.vcf
</code>

#Re-name with the new number of sites
<code>
mv finalcoralsubset_1506_2POP.filtered1SNPper.vcf finalcoralsubset_234_2POP.fil
tered1SNPper.vcf
</code>

<code>
Filter_one_random_snp_per_contig.sh finalcoralsubset_1562_4POP.recode.vcf 

mv finalcoralsubset_1562_4POP.filtered1SNPper.vcf finalcoralsubset_242_4POP.filtered1SNPper.vcf
</code>

#Filter the symbiont vcf file for 1 SNP per contig, we aren't left with any high outlier sites, are all sites are neutral. 
<code>
bash Filter_one_random_snp_per_contig.sh finalsymsubset_68.recode.vcf

mv finalsymsubset_68.filtered1SNPper.vcf finalsymsubset_19.filtered1SNPper.vcf

</code>

